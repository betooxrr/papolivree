<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Papo Livre - Pro</title>
    <!-- Importando Ícones do Google Material Symbols -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        :root {
            --bg-body: #d1d7db; --bg-app: #ffffff; --bg-chat: #efeae2;
            --header: #008069; --header-text: #ffffff; --text-main: #111b21;
            --msg-in: #ffffff; --msg-out: #dcf8c6; --sub-text: #667781;
            --border: #d1d7db; --accent: #027eb5; --input-bg: #f0f2f5;
        }

        .dark-mode {
            --bg-body: #0b141a; --bg-app: #111b21; --bg-chat: #0b141a;
            --header: #202c33; --header-text: #a8b1b8; --text-main: #e9edef;
            --msg-in: #202c33; --msg-out: #005c4b; --sub-text: #8696a0;
            --border: #222d34; --accent: #24a1de; --input-bg: #2a3942;
        }

        body { background: var(--bg-body); margin: 0; font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; height: 100dvh; overflow: hidden; transition: 0.3s; }
        
        .app-container { width: 100%; max-width: 650px; display: flex; flex-direction: column; background: var(--bg-app); height: 100%; position: relative; }
        
        /* Cabeçalho */
        .header { background: var(--header); color: #fff; padding: 0 16px; display: flex; justify-content: space-between; align-items: center; height: 65px; flex-shrink: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .header .info b { display: block; font-size: 18px; }
        .header .status { font-size: 12px; color: #c1ffda; }

        .tools { display: flex; gap: 15px; }
        .icon-btn { cursor: pointer; color: #fff; opacity: 0.8; transition: 0.3s; user-select: none; }
        .icon-btn:hover { opacity: 1; transform: scale(1.1); }
        .icon-btn.active { color: #ffeb3b; }

        /* Janela de Chat */
        .chat-window { flex: 1; overflow-y: auto; padding: 20px; background: var(--bg-chat); background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; }
        
        /* Balões */
        .msg { padding: 10px 14px; border-radius: 12px; max-width: 80%; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.15); color: var(--text-main); font-size: 15px; animation: pop 0.2s ease-out; }
        @keyframes pop { from { transform: scale(0.9); opacity: 0; } }
        
        .msg.sent { align-self: flex-end; background: var(--msg-out); border-bottom-right-radius: 2px; }
        .msg.received { align-self: flex-start; background: var(--msg-in); border-bottom-left-radius: 2px; }

        /* Cores por Nível */
        .sender { font-size: 12px; font-weight: bold; margin-bottom: 4px; display: flex; align-items: center; cursor: pointer; }
        .lvl-novato { color: #888; }
        .lvl-ativo { color: #008069; }
        .lvl-expert { color: #7209b7; }
        .lvl-lenda { color: #ff9f1c; }
        
        /* Visualização Única */
        .view-once-card { background: rgba(0,0,0,0.05); border: 1px dashed var(--accent); padding: 10px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: var(--accent); font-weight: bold; font-size: 13px; }

        /* Reações */
        .reactions { position: absolute; bottom: -14px; right: 10px; display: flex; gap: 3px; }
        .pill { background: var(--bg-app); border: 1px solid var(--border); border-radius: 10px; padding: 2px 6px; font-size: 11px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); color: var(--text-main); }

        /* Reply UI */
        .reply-box { background: rgba(0,0,0,0.06); border-left: 4px solid var(--accent); padding: 6px; border-radius: 4px; font-size: 12px; margin-bottom: 6px; color: var(--sub-text); }
        #reply-bar { background: var(--bg-app); padding: 10px 16px; border-top: 1px solid var(--border); border-left: 6px solid var(--accent); display: flex; justify-content: space-between; align-items: center; }

        /* Rodapé */
        .footer { background: var(--input-bg); padding: 10px 15px; display: flex; align-items: center; gap: 10px; border-top: 1px solid var(--border); }
        .input-box { flex: 1; background: var(--bg-app); border: none; padding: 12px 20px; border-radius: 25px; outline: none; font-size: 16px; color: var(--text-main); }
        .btn-send { width: 48px; height: 48px; background: #00a884; color: white; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn-send:active { transform: scale(0.9); }

        .time-meta { font-size: 10px; color: var(--sub-text); text-align: right; margin-top: 4px; display: flex; justify-content: flex-end; align-items: center; gap: 5px; }
        .hidden { display: none !important; }
        
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
    </style>
</head>
<body>
    <audio id="notifSound" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>

    <div class="app-container">
        <div class="header">
            <div class="info">
                <b id="userLabel">Papo Livre</b>
                <div class="status">
                    <span id="online-count">...</span> | <span id="typing-status"></span>
                </div>
            </div>
            <div class="tools">
                <span id="btnViewOnce" class="icon-btn material-symbols-outlined" title="Visualização Única">visibility_lock</span>
                <span id="btnDark" class="icon-btn material-symbols-outlined" title="Tema">dark_mode</span>
                <span onclick="window.location.href='auth.html'" class="icon-btn material-symbols-outlined" title="Sair">logout</span>
            </div>
        </div>

        <div id="msgWindow" class="chat-window"></div>

        <!-- Barra de Resposta -->
        <div id="reply-bar" class="hidden">
            <div id="reply-info" style="font-size: 13px; color: var(--text-main);"></div>
            <span onclick="window.cancelReply()" class="material-symbols-outlined" style="cursor:pointer; color: var(--sub-text);">close</span>
        </div>

        <div class="footer">
            <input type="text" id="msgInput" class="input-box" placeholder="Mensagem...">
            <button id="sendBtn" class="btn-send">
                <span class="material-symbols-outlined">send</span>
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
        import { getDatabase, ref, push, onChildAdded, onChildRemoved, onChildChanged, remove, set, get, update, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBE-pjAqlu9uD5Ko6DjLRkwjxbHH0B80aY",
            authDomain: "ch4twebonline.firebaseapp.com",
            databaseURL: "https://ch4twebonline-default-rtdb.firebaseio.com/",
            projectId: "ch4twebonline",
            storageBucket: "ch4twebonline.firebasestorage.app",
            messagingSenderId: "196624139732",
            appId: "1:196624139732:web:51bf2ffd58fb950f1a0241"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let isDarkMode = false;
        let isViewOnce = false;
        let activeReply = null;

        // Proteção XSS e Criptografia básica (Base64)
        const sanitize = (t) => { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; };
        const encrypt = (t) => btoa(unescape(encodeURIComponent(t))); 
        const decrypt = (t) => decodeURIComponent(escape(atob(t)));

        onAuthStateChanged(auth, (user) => {
            if(!user) window.location.href = 'auth.html';
            else startChat(user);
        });

        function startChat(user) {
            document.getElementById('userLabel').innerText = user.displayName;
            const input = document.getElementById('msgInput');
            const windowMsg = document.getElementById('msgWindow');

            // --- CONTROLES DE TEMA E PRIVACIDADE ---
            document.getElementById('btnDark').onclick = () => {
                isDarkMode = !isDarkMode;
                document.body.classList.toggle('dark-mode');
                document.getElementById('btnDark').innerText = isDarkMode ? 'light_mode' : 'dark_mode';
            };

            document.getElementById('btnViewOnce').onclick = () => {
                isViewOnce = !isViewOnce;
                document.getElementById('btnViewOnce').classList.toggle('active');
            };

            window.cancelReply = () => {
                activeReply = null;
                document.getElementById('reply-bar').classList.add('hidden');
            };

            // Status Online & Digitando
            const pRef = ref(db, `online/${user.uid}`);
            set(pRef, { name: user.displayName });
            onDisconnect(pRef).remove();
            onValue(ref(db, 'online'), s => document.getElementById('online-count').innerText = `${s.size || 0} online`);

            let tyTimer;
            input.oninput = () => {
                set(ref(db, `typing/${user.uid}`), { name: user.displayName });
                clearTimeout(tyTimer);
                tyTimer = setTimeout(() => set(ref(db, `typing/${user.uid}`), null), 1500);
            };
            onValue(ref(db, 'typing'), s => {
                const d = s.val(); let n = [];
                if(d) Object.values(d).forEach(u => { if(u.name !== user.displayName) n.push(u.name) });
                document.getElementById('typing-status').innerText = n.length ? n.join(', ') + " digitando..." : "";
            });

            // --- ENVIO DE MENSAGEM ---
            document.getElementById('sendBtn').onclick = () => {
                const txt = input.value.trim();
                if(!txt) return;
                const mRef = push(ref(db, 'messages'));
                set(mRef, {
                    uid: user.uid, name: user.displayName, content: encrypt(txt),
                    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                    viewOnce: isViewOnce, reply: activeReply
                }).then(() => {
                    input.value = ""; window.cancelReply();
                    isViewOnce = false; document.getElementById('btnViewOnce').classList.remove('active');
                    // Incrementar XP
                    const uRef = ref(db, `users/${user.uid}`);
                    get(uRef).then(snap => {
                        const curXp = snap.exists() ? (snap.val().xp || 0) : 0;
                        update(uRef, { xp: curXp + 1 });
                    });
                });
            };

            // --- RENDERIZAÇÃO ---
            onChildAdded(ref(db, 'messages'), async (snap) => {
                const m = snap.val();
                const id = snap.key;
                const isMe = m.uid === user.uid;

                // Busca XP e Selo de Verificado em tempo real
                const userSnap = await get(ref(db, `users/${m.uid}`));
                const uData = userSnap.val() || {};
                const xp = uData.xp || 0;
                const isVerified = uData.verified || false;

                // Cores por nível
                let lvlClass = 'lvl-novato';
                if(xp > 10) lvlClass = 'lvl-ativo';
                if(xp > 30) lvlClass = 'lvl-expert';
                if(xp > 60) lvlClass = 'lvl-lenda';

                const badge = isVerified ? '<span class="material-symbols-outlined" style="font-size:14px;color:#00d2ff;vertical-align:middle;margin-left:4px">verified</span>' : '';

                const div = document.createElement('div');
                div.id = id;
                div.className = `msg ${isMe ? 'sent' : 'received'}`;
                
                div.ondblclick = () => {
                    const rRef = ref(db, `messages/${id}/reacts/${user.uid}`);
                    get(rRef).then(s => s.exists() ? remove(rRef) : set(rRef, '❤️'));
                };

                let decryptedContent = decrypt(m.content);
                let bodyHTML = '';
                if(m.viewOnce) {
                    bodyHTML = `
                        <div class="view-once-card" onclick="window.revealMsg('${id}', '${decryptedContent}')">
                            <span class="material-symbols-outlined">visibility</span>
                            Ver Mensagem Secreta
                        </div>`;
                } else {
                    const imgRe = /(https?:\/\/.*\.(?:png|jpg|jpeg|gif|webp))/i;
                    const imgMatch = decryptedContent.match(imgRe);
                    bodyHTML = `<div>${sanitize(decryptedContent)}</div>${imgMatch ? `<img src="${imgMatch[0]}" style="max-width:100%; border-radius:8px; margin-top:8px;">` : ''}`;
                }

                div.innerHTML = `
                    ${m.reply ? `<div class="reply-box"><b>${m.reply.name}</b>: ${m.reply.text}</div>` : ''}
                    <span class="sender ${lvlClass}" onclick="window.prepReply('${m.name}', '${decryptedContent}', ${m.viewOnce})">
                        ${m.name}${badge}
                    </span>
                    <div id="body-${id}">${bodyHTML}</div>
                    <div class="time-meta">
                        <span>${m.time}</span>
                        <span class="material-symbols-outlined" onclick="window.reportMsg('${id}', '${m.uid}')" style="font-size:16px;cursor:pointer;color:orange">report</span>
                        ${isMe ? `<span onclick="window.del('${id}')" style="color:red;cursor:pointer;font-size:12px;font-weight:bold">Apagar</span>` : ''}
                    </div>
                    <div class="reactions" id="reacts-${id}"></div>
                `;

                windowMsg.appendChild(div);
                windowMsg.scrollTop = windowMsg.scrollHeight;
                if(!isMe) {
                    const sound = document.getElementById('notifSound');
                    sound.currentTime = 0;
                    sound.play().catch(()=>{});
                }
            });

            // Reações e Monitoramento de Remoção
            onChildChanged(ref(db, 'messages'), (snap) => {
                const m = snap.val(); const bar = document.getElementById(`reacts-${snap.key}`);
                if(!bar) return; bar.innerHTML = '';
                if(m.reacts) {
                    const counts = {};
                    Object.values(m.reacts).forEach(e => counts[e] = (counts[e] || 0) + 1);
                    Object.keys(counts).forEach(e => {
                        const s = document.createElement('span'); s.className = 'pill';
                        s.innerText = `${e} ${counts[e]}`; bar.appendChild(s);
                    });
                }
            });
            onChildRemoved(ref(db, 'messages'), s => document.getElementById(s.key)?.remove());

            // --- FUNÇÕES DE AÇÃO ---
            window.revealMsg = (id, content) => {
                document.getElementById(`body-${id}`).innerHTML = `<div style="color:var(--accent);font-style:italic">${content}</div>`;
                setTimeout(() => remove(ref(db, `messages/${id}`)), 10000);
            };

            window.prepReply = (n, t, isSecret) => {
                if(isSecret) return alert("Mensagens secretas não podem ser respondidas!");
                activeReply = { name: n, text: t.substring(0, 30) + '...' };
                document.getElementById('reply-bar').classList.remove('hidden');
                document.getElementById('reply-info').innerText = `Respondendo a ${n}`;
                input.focus();
            };

            window.del = (id) => { if(confirm("Apagar mensagem?")) remove(ref(db, `messages/${id}`)); };

            window.reportMsg = (msgId, authorId) => {
                if(confirm("Denunciar esta mensagem ao moderador?")) {
                    push(ref(db, 'reports'), {
                        msgId, authorId, reporter: user.displayName, time: new Date().toLocaleString()
                    });
                    alert("Denúncia enviada!");
                }
            };
        }
    </script>
</body>
</html>
